<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bedrock Server Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  </head>
<body>
    <script>
        var previous_status = "";
        var connected_players = [];
        connected_players = {{ server_manager.connected_players }};

        const websocket = new WebSocket("ws://127.0.0.1:6942/");
        websocket.addEventListener("message", ({ data }) => {
            console.log(data);
            const event = JSON.parse(data);
            switch (event.type)
            {
                case "status_update":
                    console.log("server_status");

                        if ( event.server_status == "busy")
                        {
                            document.getElementById("status-icon").setAttribute("fill", "yellow");
                        }
                        if ( event.server_status == "stopped")
                        {
                            document.getElementById("status-icon").setAttribute("fill", "red");
                        }
                        if (event.server_status == "running")
                        {
                            document.getElementById("status-icon").setAttribute("fill", "green");
                        }


                        if (previous_status == "")
                        {
                            previous_status = event.server_status;
                        }
                        if (previous_status != event.server_status)
                        {
                            previous_status = event.server_status;
                            window.location.reload();
                        }
                        previous_status = event.server_status;

                        if (connected_players !== event.connected_players && (connected_players.length != 0 && event.connected_players.length != 0))
                        {
                            console.log(event.connected_players);
                            //window.location.reload();
                        }
            }

        // do something with event
        });

        const sleep = (delay) => new Promise((resolve) => setTimeout(resolve, delay))

        async function updateServerStatus() {
            await sleep(2000);
            if (websocket.readyState == websocket.CLOSED)
            {
                window.location.reload();
            }
            if (websocket.readyState == websocket.CONNECTING)
            {
               await updateServerStatus;
            }
            else
            {
                try
                {
                    await websocket.send("update");
                }
                catch (err)
                {
                    console.log(err);
                }

                await updateServerStatus();
            }

            //let status = await fetch(window.location.origin + "/server-status");
            // console.log(window.location.origin + "/server-status");
            // if (status.ok)
            // {
            //     let json = await status.json();
            //     console.log(json);
            //     if (json.status == "pending")
            //     {
            //         await sleep(2000);
            //         await websocket.send("update");
            //         await updateServerStatus();
            //     }
            // }
        }

        updateServerStatus();
    </script>


    <style>
        body{
            background-color: rgb(21, 21, 27);
        }
        div{
            color: antiquewhite;
        }

        .row{
            padding-bottom: 50px;
        }

        form{
            padding-bottom: 10px;
        }




        /* Style for the button with id "start_server_btn" */
        #start_server_btn {
        background-color: #4CAF50; /* Green background color */
        border: none; /* Remove border */
        color: white; /* White text color */
        padding: 6px 12px; /* Add padding to the button */
        text-align: center; /* Center the text horizontally */
        text-decoration: none; /* Remove underline on text */
        display: inline-block; /* Display the button as an inline element */
        font-size: 16px; /* Set the font size */
        border-radius: 4px; /* Rounded corners */
        cursor: pointer; /* Change cursor to pointer on hover */
        }

        /* Style for the button when hovering over it */
        #start_server_btn:hover {
        background-color: #45a049; /* Slightly darker green background color */
        }

        /* Style for the button when clicked/active */
        #start_server_btn:active {
        background-color: #3e8e41; /* Even darker green background color */
        }

        /* Style for the button when disabled */
        #start_server_btn:disabled {
        background-color: #cccccc; /* Light gray background color */
        cursor: not-allowed; /* Change cursor to "not-allowed" when disabled */
        }


        #stop_server_btn {
        background-color: #af4c4c; /* Green background color */
        border: none; /* Remove border */
        color: white; /* White text color */
        padding: 6px 12px; /* Add padding to the button */
        text-align: center; /* Center the text horizontally */
        text-decoration: none; /* Remove underline on text */
        display: inline-block; /* Display the button as an inline element */
        font-size: 16px; /* Set the font size */
        border-radius: 4px; /* Rounded corners */
        cursor: pointer; /* Change cursor to pointer on hover */
        }

        /* Style for the button when hovering over it */
        #stop_server_btn:hover {
        background-color: #a04545; /* Slightly darker green background color */
        }

        /* Style for the button when clicked/active */
        #stop_server_btn:active {
        background-color: #8e3e3e; /* Even darker green background color */
        }

        /* Style for the button when disabled */
        #stop_server_btn:disabled {
        background-color: #cccccc; /* Light gray background color */
        cursor: not-allowed; /* Change cursor to "not-allowed" when disabled */
        }

        #restart_server_btn {
        background-color: #afa84c; /* Green background color */
        border: none; /* Remove border */
        color: white; /* White text color */
        padding: 6px 12px; /* Add padding to the button */
        text-align: center; /* Center the text horizontally */
        text-decoration: none; /* Remove underline on text */
        display: inline-block; /* Display the button as an inline element */
        font-size: 16px; /* Set the font size */
        border-radius: 4px; /* Rounded corners */
        cursor: pointer; /* Change cursor to pointer on hover */
        }

        /* Style for the button when hovering over it */
        #restart_server_btn:hover {
        background-color: #a09a45; /* Slightly darker green background color */
        }

        /* Style for the button when clicked/active */
        #restart_server_btn:active {
        background-color: #8d8e3e; /* Even darker green background color */
        }

        /* Style for the button when disabled */
        #restart_server_btn:disabled {
        background-color: #cccccc; /* Light gray background color */
        cursor: not-allowed; /* Change cursor to "not-allowed" when disabled */
        }



        /* Style for the text field */
        #command_field {
        width: 60%; /* Set the width of the text field */
        padding: 4px; /* Add padding to the text field */
        font-size: 16px; /* Set the font size of the text field */
        }

        /* Style for the button */
        #send_command_btn {
        background-color: #4CAF50; /* Green background color */
        border: none; /* Remove border */
        color: white; /* White text color */
        padding: 6px 12px; /* Add padding to the button */
        text-align: center; /* Center the text horizontally */
        text-decoration: none; /* Remove underline on text */
        display: inline-block; /* Display the button as an inline element */
        font-size: 16px; /* Set the font size */
        border-radius: 4px; /* Rounded corners */
        cursor: pointer; /* Change cursor to pointer on hover */
        }

        /* Style for the button when hovering over it */
        #send_command_btn:hover {
        background-color: #45a049; /* Slightly darker green background color */
        }

        /* Style for the button when clicked/active */
        #send_command_btn:active {
        background-color: #3e8e41; /* Even darker green background color */
        }



        #update_server_btn {
        background-color: #a24caf; /* Green background color */
        border: none; /* Remove border */
        color: white; /* White text color */
        padding: 6px 12px; /* Add padding to the button */
        text-align: center; /* Center the text horizontally */
        text-decoration: none; /* Remove underline on text */
        display: inline-block; /* Display the button as an inline element */
        font-size: 16px; /* Set the font size */
        border-radius: 4px; /* Rounded corners */
        cursor: pointer; /* Change cursor to pointer on hover */
        }

        /* Style for the button when hovering over it */
        #update_server_btn:hover {
        background-color: #9d45a0; /* Slightly darker green background color */
        }

        /* Style for the button when clicked/active */
        #update_server_btn:active {
        background-color: #893e8e; /* Even darker green background color */
        }

        /* Style for the button when disabled */
        #update_server_btn:disabled {
        background-color: #cccccc; /* Light gray background color */
        cursor: not-allowed; /* Change cursor to "not-allowed" when disabled */
        }

        /* Style for the dropdown (selected_level_field) */
        #selected_level_field {
            width: 100%;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            font-size: 16px;
            color: #333;
            margin-bottom: 10px;
        }

        /* Style for the "Save" button */
        #save_level_btn {
            width: 100%;
            padding: 5px;
            background-color: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        }

        #save_level_btn:hover {
            background-color: #45a049;
        }




        #zip_file_input {
            /* Your styles for the zip_file_input element go here */
            /* For example: */
            border: 1px solid #ccc;
            padding: 8px;
            width: 100%;
            margin-bottom: 10px;
        }

        #file_upload_btn {
            /* Your styles for the file_upload_btn element go here */
            /* For example: */
            background-color: #007bff;
            color: white;
            padding: 5px 10px;
            width: 100%;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
    </style>

    <div>
        <p>
        Server Status:
        <svg id="status-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="{{ server_manager.color_status }}" class="bi bi-circle-fill" viewBox="0 0 16 16">
            <circle cx="8" cy="8" r="8"/>
        </svg>
        </p>
    </div>


    <div class="container text-center">


        <div class="row">
          <div class="col">
            <form method="post", action="/start-server">
                {{ forms["start_form"].csrf_token }}
                {{ forms["start_form"].start_server_btn() }}
            </form>
            <form method="post", action="/stop-server">
                {{ forms["stop_form"].csrf_token }}
                {{ forms["stop_form"].stop_server_btn() }}
            </form>
            <form method="post", action="/restart-server">
                {{ forms["restart_form"].csrf_token }}
                {{ forms["restart_form"].restart_server_btn() }}
            </form>
          </div>
          <div class="col">

          </div>
        </div>



        <div class="row">
            <div class="col">
                <form method="post", action="/update-server">
                    {{ forms["update_form"].csrf_token }}
                    {{ forms["update_form"].update_server_btn() }}
                </form>
            </div>
              <div class="col">
              </div>
              <div class="col">
              </div>
          </div>


        <div class="row">
              <div class="col">
                  <form method="post", action="/send-command">
                      {{ forms["command_form"].csrf_token }}
                      {{ forms["command_form"].label }}
                      {{ forms["command_form"].command_field() }}
                      {{ forms["command_form"].send_command_btn() }}
                  </form>
              </div>
          </div>

          <div class="row">
            <div class="col">
                <form method="post", action="/change-level">
                    {{ forms["level_form"].csrf_token }}
                    {{ forms["level_form"].selected_level_field() }}
                    {{ forms["level_form"].save_level_btn() }}
                </form>
            </div>
              <div class="col">
                <form method="post", enctype="multipart/form-data", action="/upload-level">
                    {{ forms["level_upload_form"].csrf_token }}
                    {{ forms["level_upload_form"].zip_file_field() }}
                    {{ forms["level_upload_form"].file_upload_btn() }}
                </form>
              </div>
          </div>

          <div class="row">
            <div class="col">
            <h3>Connected Players: </h3>
            <ul class="list-group">
                {% for player in server_manager.connected_players %}
                    <li class="list-group-item">{{ player }}</li>
                {% endfor %}
            </ul>
            </div>
            <div class="col"></div>
            <div class="col"></div>
          </div>

    </div>
</body>
